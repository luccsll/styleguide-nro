import{_handleProcessError}from"./errorHandler.min.js";import{_searchLeader}from"./search.min.js";import{_capitalizeText}from"./utils.min.js";export function _setStep(e,t,a){const s=e;s.empty(),t.forEach(((e,t)=>{const a=new Date(e.deadline),{resultDate:n,progressWidth:o,barColor:i}=formatDateInfo(a);let l=`\n        <li class="stepNro" data-id="${t+1}" data-deadline="${e.deadline}">\n            <span class="infoClickHover" data-id="${t+1}">Clique aqui para mais informações</span>\n            <div class="progress progressNro">\n                <div class="progress-bar progressBarNro"\n                     role="progressbar"\n                     data-target="${o}"\n                     data-color="${i}"\n                     aria-valuemin="0" aria-valuemax="100"\n                     style="width:0%">\n                </div>\n            </div>\n            <div class="stepContent">\n                <h2 class="stepContentActivity">${e.activity}</h2>\n                <div class="stepContentInfo">`;var r="";if(isNaN(Number(e.responsible)))r=e.responsible.length>14?e.responsible.substring(0,14)+"...":e.responsible;else{var d=getDataColleague(e.responsible);if(!d||!d.colleagueName)return void _handleProcessError(`Erro ao buscar o responsável pela etapa ${e.activity} - ${e.numActivity} - ERRO 002`);r=d.colleagueName.length>14?d.colleagueName.substring(0,14)+"...":d.colleagueName}null==e.responsible?l+='<p class="stepContentOwner" style="visibility: hidden;">und</p>':l+=`<p class="stepContentOwner">${_capitalizeText(r,"title")}</p>`,null==e.deadline?l+='<p class="stepContentDeadline" style="visibility: hidden;"><span class="stepContentTime">und</span></p>':l+=`<p class="stepContentDeadline"><span class="stepContentTime">${n}</span></p>`,l+="</div></div></li>",s.append(l)})),$(".infoClickHover").on("click",(function(){const e=$(this).data("id"),s=t[e-1];var n="";if(isNaN(Number(s.responsible)))n=`<img src="https://cdn.jsdelivr.net/gh/luccsll/styleguide-nro@4060759ad8eaf3dff0c460003f2df6ad93df14f3/img/group.png" class="photoModalStep">\n                            <div class="contentModalItem-text">\n                                <a class="modalStepName">${s.responsible||"Não definido"}</a>\n                            </div>`;else{var o=getDataColleague(s.responsible),i=o.mail;i=i.split("@");var l=JSON.parse(_searchLeader("ds-aditivo-encerrameto-dataUser",s.responsible,"solic"));n=`<img src="/social/api/rest/social/image/profile/${i[0]}/MEDIUM_PICTURE" class="photoModalStep"></img>\n                            <div class="contentModalItem-text">\n                                <a class="clickable" href="https://concessionariarota156340.fluig.cloudtotvs.com.br:1700/portal/p/1/social/${i[0]}" target="_blank">${o.colleagueName||"Não definido"}</a>\n                                ${"user"===s.typeResponsible||"solic"===s.typeResponsible?`<p class="modalStepPosition">${capitalizeFirstLetter(l.data.funcSolic)}</p>`:""}\n                            </div>`}let r=a[0].nameProcess?a[0].nameProcess:"Processo";const d=`\n            <div class="backgroundModal" id="modalStep${e}">\n                <div class="contentModal">\n                    <div class="contentModalHeader">\n                        <h1 class="contentModalTitle">${s.activity} <button class="buttonCloseModalStep"><img src="https://cdn.jsdelivr.net/gh/luccsll/styleguide-nro@main/icons/flaticon-close.png"></img></button></h1>\n                        <p class="contentModalSubtitle">${r} </p>\n                    </div>\n                    <div class="contentModalBody">\n                        <div class="contentModalRow">\n                            <div class="contentModalItem">\n                                <p class="subtitleModalItem">Descrição da etapa</p>\n                                <p class="textContentModal">${s.description}</p>\n                            </div>\n                            <div class="contentModalItem">\n                                <p class="subtitleModalItem">Prazo de atendimento</p>\n                                <p class="textContentModal">${s.deadline?new Date(s.deadline).toLocaleString():"Sem prazo definido"}</p>\n                            </div>\n                        </div>\n                        <div class="contentModalRow">\n                            <div class="contentModalItem">\n                                <p class="subtitleModalItem">Responsável pela etapa</p>\n                                <div class="contentModalItem-profile">\n                                    ${n}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;$("body").append(d),$("#modalStep"+e).show(),$(".buttonCloseModalStep").on("click",(function(){$("#modalStep"+e).remove()}))}))}export function _setStepActive(e,t){let a=600;e.children(".stepNro:visible").each((function(){var e=$(this);e.removeClass("stepActiveNro"),setTimeout((()=>{const a=e.data("id"),s=e.find(".progressBarNro"),n=e.data("deadline");if(a<t)e.removeClass("stepActiveNro"),e.addClass("stepCompletNro");else if(a===t&&(e.addClass("stepActiveNro"),!n))return void s.css({width:"100%",backgroundColor:"white"});const o=new Date(n),i=new Date;if(a<t)s.css("width","100%"),setTimeout((()=>{e.find(".stepContentDeadline").text("Concluído")}),1900);else if(a===t){const e=new Date(i.getFullYear(),i.getMonth(),i.getDate()),t=o.getTime()-e.getTime(),a=i.getTime()-e.getTime();let n=0,l="white";if(i>=o)n=100,l="var(--color-danger) !important";else{n=(a/t*100).toFixed(1);const e=100-n;l=e>50?"white":e>15?"var(--color-warning) !important":e>0?"var(--color-nro-06) !important":"var(--color-danger) !important"}s.css({width:`${n}%`,backgroundColor:l})}}),a),a+=1900}))}function formatDateInfo(e){const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(e.getFullYear(),e.getMonth(),e.getDate()),n=e.getDate().toString().padStart(2,"0"),o=(e.getMonth()+1).toString().padStart(2,"0"),i=`${e.getHours()}:${e.getMinutes().toString().padStart(2,"0")}`,l=`${n}/${o}`;let r="",d=0,c="white";return e.getTime()<t.getTime()&&(d=100,c="var(--color-danger) !important"),r=s.getTime()===a.getTime()?"Hoje às "+i:s.getTime()===a.getTime()+864e5?"Amanhã às "+i:e.getTime()<t.getTime()?"Vencido em "+l+" às "+i:l+" às "+i,{hour:i,shortDate:l,resultDate:r,progressWidth:d,barColor:c}}function getDataColleague(e){var t=new Array(DatasetFactory.createConstraint("currentProject",e,e,ConstraintType.MUST));return(e=DatasetFactory.getDataset("colleague",null,t,null)).values[e.values.length-1]}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}